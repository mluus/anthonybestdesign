/**
 * Shareprints Gallery
 *
 * @package   Shareprints
 * @author    JR w/Freak Plugins <jr@freakplugins.com>
 * @license   GPLv3+
 * @link      http://freakplugins.com
 * @copyright Copyright (c) 2014 Freak Plugins, LLC - All Rights Reserved
 */(function(){tinymce.create("tinymce.plugins.shareprints_shortcode_editor",{init:function(e,t){var n=this;n.url=t;n.editor=e;n._createButtons();e.addCommand("SP_Gallery",function(){tinymce.isIE&&e.selection.moveToBookmark(e.spGalleryBookmark);var t=e.selection.getNode();if(t.nodeName!="IMG"||e.dom.getAttrib(t,"class").indexOf("sp-gallery")==-1)return;var n=wp.shortcode.next("shareprints","["+e.dom.getAttrib(t,"title")+"]");n=n.shortcode.attrs.named;sp_mce_app.updateModal(t,n)});e.onInit.add(function(e){"ontouchstart"in window&&e.dom.events.add(e.getBody(),"touchstart",function(t){var r=t.target;if(r.nodeName=="IMG"&&e.dom.hasClass(r,"sp-gallery")){e.selection.select(r);e.dom.events.cancel(t);n._hideButtons();n._showButtons(r,"sp_gallerybtns")}});tinymce.dom.Event.add(e.getWin(),"scroll",function(){n._hideButtons()});tinymce.dom.Event.add(e.getBody(),"dragstart",function(){n._hideButtons()})});e.onMouseDown.add(function(e,t){if(t.target.nodeName=="IMG"&&e.dom.hasClass(t.target,"sp-gallery")){n._hideButtons();n._showButtons(t.target,"sp_gallerybtns")}else n._hideButtons()});e.onBeforeSetContent.add(function(e,t){t.content=n._do_gallery(t)});e.onPostProcess.add(function(e,t){t.get&&(t.content=n._get_gallery(t.content))});e.onBeforeExecCommand.add(function(e){n._hideButtons()});e.onSaveContent.add(function(e){n._hideButtons()});e.onKeyDown.add(function(e,t){(t.which==tinymce.VK.DELETE||t.which==tinymce.VK.BACKSPACE)&&n._hideButtons()})},_do_gallery:function(e){var t=this,n=e.content;return n.replace(/\[shareprints([^\]]*)\]/g,function(e,n){var r=wp.shortcode.attrs(e).named;cls=r.gallery_type?r.gallery_type:"",pos=r.gallery_position?r.gallery_position:"",width=r.gallery_width?r.gallery_width:"";return'<img src="'+t.url+'/img/t.gif" class="sp-gallery mceItem '+cls+" "+pos+" "+width+'" title="shareprints'+tinymce.DOM.encode(n)+'"/>'})},_get_gallery:function(e){function t(e,t){t=(new RegExp(t+'="([^"]+)"',"g")).exec(e);return t?tinymce.DOM.decode(t[1]):""}return e.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(e,n){var r=t(n,"class");return r.indexOf("sp-gallery")!=-1?"["+tinymce.trim(t(n,"title"))+"]":e})},_createButtons:function(){var e=this,t=tinymce.activeEditor,n=tinymce.DOM,r,i;if(n.get("sp_gallerybtns"))return;n.add(document.body,"div",{id:"sp_gallerybtns",style:"display:none;"});r=n.add("sp_gallerybtns","img",{src:e.url+"/img/t.gif",id:"sp_editgallery",width:"24",height:"24",title:t.getLang("wordpress.editgallery")});tinymce.dom.Event.add(r,"mousedown",function(){var t=tinymce.activeEditor;t.spGalleryBookmark=t.selection.getBookmark("simple");t.execCommand("SP_Gallery");e._hideButtons()});i=n.add("sp_gallerybtns","img",{src:e.url+"/img/t.gif",id:"sp_delgallery",width:"24",height:"24",title:t.getLang("wordpress.delgallery")});tinymce.dom.Event.add(i,"mousedown",function(t){var n=tinymce.activeEditor,r=n.selection.getNode();if(r.nodeName=="IMG"&&n.dom.hasClass(r,"sp-gallery")){n.dom.remove(r);n.execCommand("mceRepaint");n.dom.events.cancel(t)}e._hideButtons()})},_hideButtons:function(){var e=tinymce.DOM;e.hide(e.select("#sp_gallerybtns"))},_showButtons:function(e,t){var n=tinymce.activeEditor,r,i,s,o=tinymce.DOM,u,a;s=n.dom.getViewPort(n.getWin());r=o.getPos(n.getContentAreaContainer());i=n.dom.getPos(e);u=Math.max(i.x-s.x,0)+r.x;a=Math.max(i.y-s.y,0)+r.y;o.setStyles(t,{top:a+5+"px",left:u+5+"px",display:"block"})},getWin:function(){return window.dialogArguments||opener||parent||top},getInfo:function(){return{longname:"Gallery Settings",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}});tinymce.PluginManager.add("shareprints_shortcode_editor",tinymce.plugins.shareprints_shortcode_editor)})();