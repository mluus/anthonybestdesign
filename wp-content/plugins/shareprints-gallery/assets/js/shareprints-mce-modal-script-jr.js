/**
 * Shareprints Gallery
 *
 * @package   Shareprints
 * @author    JR w/Freak Plugins <jr@freakplugins.com>
 * @license   GPLv3+
 * @link      http://freakplugins.com
 * @copyright Copyright (c) 2014 Freak Plugins, LLC - All Rights Reserved
 */$j=jQuery.noConflict();var sp_mce_app={init:function(){$j(function(){sp_mce_app.modal()})},el:{shareprints_open:$j("#shareprints_open"),modal:$j("#shareprints_mce_modal"),sp_submit:$j("#shareprints_mce_modal").find("#sp_submit"),sp_update:$j("#shareprints_mce_modal").find("#sp_update"),sp_cancel:$j("#shareprints_mce_modal").find(".sp_cancel"),sp_save:$j("#shareprints_mce_modal").find("#sp_save"),sp_edit_gallery:$j("#shareprints_mce_modal").find("#sp_edit_gallery"),sp_delete_gallery:$j("#shareprints_mce_modal").find("#sp_delete_gallery"),sp_create_gallery:$j("#shareprints_mce_modal").find("#sp_create_gallery"),gallery_select:$j("#shareprints_mce_modal").find("#gallery_id"),gallery_select_actions:$j("#shareprints_mce_modal").find("#gallery_select_actions"),saved_settings:$j("#shareprints_mce_modal").find("#saved_settings"),saved_settings_actions:$j("#shareprints_mce_modal").find("#saved_settings_actions"),alert_holder:$j("#shareprints_mce_modal").find(".sp_alert_holder"),editor_alert_holder:$j("#shareprints_gallery_editor").find(".sp_alert_holder"),gallery_editor:$j("#shareprints_gallery_editor"),gallery_editor_title:$j("#shareprints_gallery_editor").find(".sp_modal-title"),gallery_editor_meta_box:$j("#shareprints_gallery_editor").find("#gallery_meta_box"),sp_publish_gallery:$j("#shareprints_gallery_editor").find("#sp_publish_gallery"),sp_update_gallery:$j("#shareprints_gallery_editor").find("#sp_update_gallery"),sp_cancel_gallery:$j("#shareprints_gallery_editor").find(".sp_cancel_gallery"),alert:$j('<div class="alert alert-dismissable alert-danger"><a data-object="close" class="close">&times;</a><strong></strong></div>'),success:$j('<div class="alert alert-dismissable alert-success"><a data-object="close" class="close">&times;</a><strong></strong></div>')},inputs:{},editors:{},modal:function(){$j(document).on("click","#shareprints_open",function(e){sp_mce_app.el.modal.sp_modal("show")});sp_mce_app.modalEvents();sp_mce_app.el.modal.find(".form-control").each(function(){var e,t=$j(this).get(0);t.tagName=="INPUT"&&(e=t.type);t.tagName=="SELECT"&&(e="select");sp_mce_app.inputs[t.name]=e})},modalEvents:function(){var e=sp_mce_app;e.el.modal.on("hidden.sp.sp_modal",function(t){e.el.alert_holder.empty();e.el.sp_update.hide();e.el.sp_submit.show();e.el.modal.find(".sp_modal-nav .main a").trigger("click")});e.el.gallery_editor.on("hidden.sp.sp_modal",function(t){e.el.sp_update_gallery.unbind("click");e.el.sp_publish_gallery.unbind("click");e.el.editor_alert_holder.empty();wp.media.view.settings.post.id=shareprints.orig_post_id;e.el.modal.sp_modal("show")});e.el.sp_cancel.click(function(){e.el.modal.sp_modal("hide")});e.el.sp_cancel_gallery.click(function(){e.el.gallery_editor.sp_modal("hide");e.el.modal.sp_modal("show")});e.el.modal.find(".sp_modal-nav a").click(function(e){e.preventDefault();$j(this).sp_tab("show")});e.el.alert.add(e.el.success).find("a").click(function(){$j(this).parent().detach()});e.el.modal.find(".sp_help span").sp_tooltip({animation:!1,placement:"left",container:"#shareprints_mce_modal"});e.el.sp_submit.click(function(){e.modalSubmit()});e.el.sp_update.click(function(){e.modalUpdate()});e.el.sp_save.click(function(){e.saveFavorite()});e.el.saved_settings_actions.find("a").click(function(){if(!$j(this).hasClass("disabled")){var t=$j(this).data("action"),n=e.el.saved_settings.val();if(!n){var r=e.el.saved_settings.data("error");e.el.alert.find("strong").remove().end().append("<strong>"+r+"</strong>");e.el.alert_holder.append(e.el.alert);return}e.el.alert_holder.empty();t==="load"&&e.loadFavorite(n);t==="delete"&&e.deleteFavorite(n)}});e.el.gallery_select_actions.find("a").click(function(){var t=e.el.gallery_select.val(),n=$j(this).data("action");if(n==="create"){e.createGallery();return}if(!t||t===""){var r=e.el.gallery_select.data("error");e.el.alert.find("strong").remove().end().append("<strong>"+r+"</strong>");e.el.alert_holder.append(e.el.alert);return}e.el.alert_holder.empty();n==="edit"&&e.editGallery(t);n==="delete"&&e.deleteGallery(t)})},createGallery:function(){var e=sp_mce_app;e.loadMetaBox(0,"create");e.el.sp_publish_gallery.click(function(){if($j(this).data("disabled"))return;var t=e.el.gallery_editor.find("#gallery_title");if(!t.val()||t.val()==""){var n=t.data("error");e.el.alert.find("strong").remove().end().append("<strong>"+n+"</strong>");e.el.editor_alert_holder.append(e.el.alert);return}e.el.editor_alert_holder.empty();t=t.val();var r={post_title:t,ID:e.el.gallery_editor_meta_box.find("#shareprints_gallery_images").data("id"),shareprints_images:[],action:"create",shareprints_images_nonce:shareprints.l10n.save_update_nonce},i=e.el.gallery_editor.find(".shareprints-image-value").serializeArray();for(var s=0;s<i.length;s++)r.shareprints_images[s]=i[s].value;r.shareprints_images.length||(r.shareprints_images="");$j(this).unbind("click");e.save_update(r)})},editGallery:function(e){var t=sp_mce_app;t.loadMetaBox(e,"edit");t.el.sp_update_gallery.click(function(){if($j(this).data("disabled"))return;var n=t.el.gallery_editor.find("#gallery_title");if(!n.val()||n.val()==""){var r=n.data("error");t.el.alert.find("strong").remove().end().append("<strong>"+r+"</strong>");t.el.editor_alert_holder.append(t.el.alert);return}t.el.editor_alert_holder.empty();n=n.val();var i={post_title:n,ID:e,shareprints_images:[],action:"edit",shareprints_images_nonce:shareprints.l10n.save_update_nonce},s=t.el.gallery_editor.find(".shareprints-image-value").serializeArray();for(var o=0;o<s.length;o++)i.shareprints_images[o]=s[o].value;i.shareprints_images.length||(i.shareprints_images="");$j(this).unbind("click");t.save_update(i)})},deleteGallery:function(e){var t=sp_mce_app;$j.ajax({type:"POST",dataType:"json",data:{security_seed:shareprintsAjax.ajax_nonce,gallery_id:e},url:shareprintsAjax.url+"?action=delete_shareprints_gallery",success:function(e){if(e!=="failure"){t.el.gallery_select.find("[value="+e.ID+"]").remove();t.el.gallery_select.find("option").length<1&&t.el.sp_edit_gallery.add(t.el.sp_delete_gallery).addClass("disabled");t.el.success.find("strong").remove().end().append("<strong>"+e.msg+"</strong>");t.el.alert_holder.append(t.el.success)}else{t.el.alert.find("strong").remove().end().append("<strong>"+e+"</strong>");t.el.alert_holder.append(t.el.alert)}},error:function(e){}})},save_update:function(e){var t=sp_mce_app;t.el.sp_update_gallery.add(t.el.sp_publish_gallery).data("disabled",!0);$j.ajax({type:"POST",dataType:"json",data:{security_seed:shareprintsAjax.ajax_nonce,ID:e.ID,post_title:e.post_title,shareprints_images:e.shareprints_images,shareprints_images_nonce:e.shareprints_images_nonce,sp_action:e.action},url:shareprintsAjax.url+"?action=save_update_shareprints_gallery",success:function(e){var n=t.el.gallery_select.find("[value="+e.ID+"]");if(n.length>0){t.el.gallery_select.val(e.ID);n.text(e.post_title)}else{n=$j('<option value="'+e.ID+'">'+e.post_title+"</option>");t.el.gallery_select.prepend(n).val(e.ID)}t.el.sp_update_gallery.add(t.el.sp_publish_gallery).data("disabled",!1);t.el.gallery_select.find("option").length&&t.el.gallery_select_actions.children().removeClass("disabled");t.el.gallery_editor.sp_modal("hide");t.el.modal.sp_modal("show")},error:function(e){}})},loadMetaBox:function(e,t){var n=sp_mce_app;$j.ajax({type:"POST",dataType:"html",action:t,data:{security_seed:shareprintsAjax.ajax_nonce,gallery_id:e},url:shareprintsAjax.url+"?action=return_shareprints_gallery",success:function(r){n.el.gallery_editor_meta_box.empty().append(r);if(t==="edit"){n.el.gallery_editor_title.text(shareprints.l10n.edit_modal_title);n.el.sp_update_gallery.show();n.el.sp_publish_gallery.hide()}if(t==="create"){n.el.gallery_editor_title.text(shareprints.l10n.add_modal_title);n.el.sp_update_gallery.hide();n.el.sp_publish_gallery.show()}shareprints.orig_post_id=wp.media.view.settings.post.id;wp.media.view.settings.post.id=e>0?parseInt(e):n.el.gallery_editor_meta_box.find("#shareprints_gallery_images").data("id");n.el.modal.sp_modal("hide");n.el.gallery_editor.sp_modal("show");$j(document).trigger("shareprints/setup_images",[n.el.gallery_editor])},error:function(e){}})},modalSubmit:function(){var e=sp_mce_app,t=e.getValues(),n="";if(!t.gallery_id){var r=e.el.gallery_select.data("error");e.el.alert.find("strong").remove().end().append("<strong>"+r+"</strong>");e.el.alert_holder.append(e.el.alert);return}e.el.alert_holder.empty();$j.each(t,function(e,t){if(e==="save_name")return;n+=e+'="'+t+'" '});var i=t.gallery_type+" "+t.gallery_position+" "+t.gallery_width,s=tinymce.Env!==undefined?tinymce.Env.transparentSrc:shareprintsAjax.assetpath+"/tinymce/img/t.gif";window.send_to_editor('<img src="'+s+'" class="sp-gallery mceItem '+i+'" title="shareprints '+tinymce.DOM.encode(n)+'" data-gallery-type="'+t.gallery_type+'" data-mce-resize="false"/>');$j("#content-tmce").trigger("click");e.el.modal.sp_modal("hide")},modalUpdate:function(){var e=sp_mce_app,t=e.getValues(),n="",r=t.gallery_type?t.gallery_type:"",i=t.gallery_position?t.gallery_position:"",s=t.gallery_width?t.gallery_width:"";if(!t.gallery_id){var o=e.el.gallery_select.data("error");e.el.alert.find("strong").remove().end().append("<strong>"+o+"</strong>");e.el.alert_holder.append(e.el.alert);return}$j.each(t,function(e,t){if(e==="save_name")return;n+=e+'="'+t+'" '});tinymce.DOM.setAttrib(e.el.shortcode,"title","shareprints "+n);tinymce.DOM.setAttrib(e.el.shortcode,"class","sp-gallery mceItem "+r+" "+i+" "+s+" ");e.el.modal.sp_modal("hide")},getValues:function(){var e={},t=sp_mce_app.el.modal.find(".form-control").serializeArray();for(var n=0;n<t.length;n++)e[t[n].name]=t[n].value;return e},updateModal:function(e,t){var n=sp_mce_app;n.el.shortcode=e;n.el.attrs=t;n.el.sp_update.show();n.el.sp_submit.hide();console.log();$j.each(n.inputs,function(e,r){if(!e)return;var i=n.el.modal.find("[name="+e+"]");r==="select"&&i.val(t[e]);r==="radio"&&i.filter("#"+e+"-"+t[e]).trigger("click");r==="checkbox"&&(t[e]?i.prop("checked",!0).parent().addClass("active"):i.prop("checked",!1).parent().removeClass("active"))});n.el.modal.sp_modal("show");return},saveFavorite:function(){var e=sp_mce_app,t=e.getValues();if(!t.save_name){var n=e.el.modal.find("#save_name").data("error");e.el.alert.find("strong").remove().end().append("<strong>"+n+"</strong>");e.el.alert_holder.append(e.el.alert);return}e.el.alert_holder.empty();$j.ajax({type:"POST",dataType:"json",data:{security_seed:shareprintsAjax.ajax_nonce,values:t},url:shareprintsAjax.url+"?action=save_mce_modal_settings",success:function(t){var n=e.el.saved_settings.find("[value="+t.settings_id+"]");if(n.length>0){n.data("values",t.values);e.el.saved_settings.val(t.settings_id)}else{n=$j('<option value="'+t.settings_id+'">'+t.save_name+"</option>").data("values",t.values);e.el.saved_settings.append(n).val(t.settings_id)}e.el.saved_settings_actions.children().removeClass("disabled");e.el.modal.find("#save_name").val("")},error:function(e){}})},deleteFavorite:function(e){var t=sp_mce_app,n=t.el.saved_settings.find("[value="+e+"]"),r=n.data("values");$j.ajax({type:"POST",dataType:"json",data:{security_seed:shareprintsAjax.ajax_nonce,save_name:r.save_name,settings_id:e},url:shareprintsAjax.url+"?action=delete_mce_modal_settings",success:function(r){if(r.settings_id!==e)return;n.remove();r.count<1&&t.el.saved_settings_actions.children().addClass("disabled")},error:function(e){}})},loadFavorite:function(e){var t=sp_mce_app,n=t.el.saved_settings.find("[value="+e+"]"),r=n.data("values");$j.each(t.inputs,function(e,n){if(e==="gallery_id"||!e)return;var i=t.el.modal.find("[name="+e+"]");n==="select"&&i.val(r[e]);n==="radio"&&i.filter("#"+e+"-"+r[e]).trigger("click");n==="checkbox"&&(r[e]?i.prop("checked",!0).parent().addClass("active"):i.prop("checked",!1).parent().removeClass("active"))});var i=t.el.modal.find("#saved_settings").data("success");t.el.success.find("strong").remove().end().append("<strong>"+i+"</strong>");t.el.alert_holder.append(t.el.success)}};sp_mce_app.init();